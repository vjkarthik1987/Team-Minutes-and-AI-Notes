<% layout('layout') %>

<%
const _prev = Array.isArray(prevEvents) ? prevEvents : [];
const _err  = error || null;

function pickStart(ev) {
  return ev?.startDateTime || ev?.start?.dateTime || '';
}
function pickEnd(ev) {
  return ev?.endDateTime || ev?.end?.dateTime || '';
}
function pickLoc(ev) {
  return ev?.location || ev?.location?.displayName || '';
}
function pickEventId(ev) {
  return ev?.eventId || ev?.id || '';
}
function pickTranscript(ev) {
  // cached shape: ev.transcripts[0] = { meetingId, transcriptId }
  if (Array.isArray(ev?.transcripts) && ev.transcripts.length) {
    return {
      meetingId: ev.transcripts[0].meetingId,
      transcriptId: ev.transcripts[0].transcriptId,
    };
  }
  // graph shape: ev._transcripts[0] = { meetingId, id }
  if (ev?._hasTranscript && Array.isArray(ev?._transcripts) && ev._transcripts.length) {
    return {
      meetingId: ev._transcripts[0].meetingId,
      transcriptId: ev._transcripts[0].id,
    };
  }
  return null;
}
%>

<h1>My Calendar</h1>
<!-- OPTIONAL: Add this near the top of views/user/calendar.ejs (under the title) -->
<%
  const _pastDays = typeof pastDays !== 'undefined' ? pastDays : 30;
  const _lastSyncedAt = (typeof lastSyncedAt !== 'undefined') ? lastSyncedAt : null;
%>

<div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 8px 0 16px;">
  <div style="font-size:13px; opacity:.8;">
    <% if (lastSyncedAt) { %>
      Last synced: <%= new Date(lastSyncedAt).toLocaleString() %>
    <% } else { %>
      Not synced yet (click Refresh)
    <% } %>
  </div>

  <div style="display:flex; gap:10px; align-items:center;">
    <a
      href="/user/calendar?pastDays=<%= encodeURIComponent(pastDays || 30) %>&refresh=1"
      style="padding:8px 12px; border:1px solid #ddd; border-radius:10px; text-decoration:none;"
    >
      Refresh
    </a>

    <a href="/user/home" style="font-size:13px;">Back</a>
  </div>
</div>

<% if (error) { %>
  <div style="padding:10px 12px; border:1px solid #fca5a5; background:#fef2f2; border-radius:10px; margin-bottom:14px;">
    <strong>Error:</strong> <%= error %>
  </div>
<% } %>


<p><a href="/user/home">← Back to home</a></p>

<p>
  <strong>User:</strong> <%= user.email %><br/>
  <strong>Org:</strong> <%= org.name %>
</p>

<% if (_err) { %>
  <p style="color:#b00020; margin-top:12px;">
    <strong>Error:</strong> <%= _err %>
  </p>
<% } %>

<hr style="margin:18px 0;" />

<h2>Last 30 days - including today</h2>

<% if (_prev.length === 0) { %>
  <p>No events found.</p>
<% } else { %>
  <ul>
    <% _prev.forEach(ev => { %>
      <%
        const startDT = pickStart(ev);
        const endDT   = pickEnd(ev);
        const loc     = pickLoc(ev);
        const eventId = pickEventId(ev);
        const tx      = pickTranscript(ev);
      %>

      <li style="margin-bottom:12px;">
        <strong><%= ev.subject || '(no subject)' %></strong><br/>
        <span><%= startDT %> → <%= endDT %></span><br/>

        <% if (loc) { %>
          <span><%= loc %></span><br/>
        <% } %>

        <% if (tx) { %>
          <a
            href="/user/transcript/ensure/<%= tx.meetingId %>/<%= tx.transcriptId %>?eventId=<%= encodeURIComponent(eventId) %>&subject=<%= encodeURIComponent(ev.subject || '') %>&start=<%= encodeURIComponent(startDT) %>&end=<%= encodeURIComponent(endDT) %>"
            target="_blank"
            rel="noopener"
          >Transcript</a>
        <% } %>
      </li>
    <% }) %>
  </ul>
<% } %>

<hr style="margin:18px 0;" />

