<% layout('layout') %>

<%
  function fmtRange(startIso, endIso) {
    const s = startIso ? new Date(startIso) : null;
    const e = endIso ? new Date(endIso) : null;
    if (!s || isNaN(s.getTime())) return '';

    const dateFmt = new Intl.DateTimeFormat('en-IN', {
      weekday: 'short',
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });

    const timeFmt = new Intl.DateTimeFormat('en-IN', {
      hour: 'numeric',
      minute: '2-digit'
    });

    const dateStr = dateFmt.format(s);
    const startStr = timeFmt.format(s);

    if (!e || isNaN(e.getTime())) {
      return `${dateStr} • ${startStr}`;
    }

    const endStr = timeFmt.format(e);
    const durMin = Math.max(0, Math.round((e - s) / 60000));
    const dur =
      durMin >= 60
        ? `${Math.floor(durMin / 60)}h ${durMin % 60}m`
        : `${durMin}m`;

    return `${dateStr} • ${startStr} – ${endStr} (${dur})`;
  }

  function dayKey(iso) {
    const d = new Date(iso);
    d.setHours(0,0,0,0);
    return d.toISOString();
  }

  const groups = {};
  (prevEvents || []).forEach(ev => {
    const key = dayKey(ev.startDateTime);
    groups[key] = groups[key] || [];
    groups[key].push(ev);
  });

  const days = Object.keys(groups).sort((a,b)=> new Date(b)-new Date(a));
%>

<div class="page-head">
  <div>
    <h1 class="title">Meetings with transcripts</h1>
    <p class="muted">
      Cached view — opens instantly. Refresh only when needed.
    </p>
  </div>

  <div class="page-head__right">
    <a class="btn btn-ghost" href="/user/calendar?refresh=1">↻ Refresh</a>
  </div>
</div>

<% if (!days.length) { %>
  <div class="card empty">
    <p>No meetings with transcripts found.</p>
  </div>
<% } %>

<% days.forEach(day => { %>
  <div class="day-block">
    <div class="day-title">
      <%= new Intl.DateTimeFormat('en-IN', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }).format(new Date(day)) %>
    </div>

    <% groups[day].forEach(ev => { 
        const t = fmtRange(ev.startDateTime, ev.endDateTime);
        const tr = ev.transcripts?.[0];
    %>

      <a class="meeting-card"
         href="/user/transcript/ensure/<%= tr.meetingId %>/<%= tr.transcriptId %>?eventId=<%= ev.eventId %>&subject=<%= encodeURIComponent(ev.subject || '') %>&start=<%= ev.startDateTime %>&end=<%= ev.endDateTime %>">

        <div class="meeting-main">
          <div class="meeting-subject">
            <%= ev.subject || '(no subject)' %>
          </div>

          <div class="meeting-meta">
            <%= t %>
          </div>
        </div>

        <div class="meeting-cta">
          Open →
        </div>
      </a>

    <% }) %>
  </div>
<% }) %>

<style>
/* Page */
.page-head{
  display:flex;
  justify-content:space-between;
  gap:16px;
  margin-bottom:18px;
}
.title{
  margin:0;
  font-size:28px;
  letter-spacing:-0.02em;
}
.muted{ color:var(--muted); font-size:13px; }

/* Day grouping */
.day-block{ margin-top:22px; }
.day-title{
  font-size:13px;
  font-weight:600;
  color:var(--muted);
  margin-bottom:10px;
}

/* Meeting card */
.meeting-card{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:14px 16px;
  border:1px solid var(--border);
  border-radius:14px;
  background:#fff;
  text-decoration:none;
  color:var(--text);
  margin-bottom:10px;
  transition: box-shadow .15s ease, transform .15s ease;
}
.meeting-card:hover{
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  transform: translateY(-1px);
}

.meeting-main{ min-width:0; }
.meeting-subject{
  font-size:15px;
  font-weight:600;
  line-height:1.3;
}
.meeting-meta{
  margin-top:4px;
  font-size:13px;
  color:var(--muted);
}

/* CTA */
.meeting-cta{
  font-size:13px;
  color:var(--accent);
  font-weight:600;
  white-space:nowrap;
}

/* Empty */
.card.empty{
  padding:24px;
  border:1px dashed var(--border);
  border-radius:14px;
  color:var(--muted);
}

/* Mobile */
@media (max-width:720px){
  .title{ font-size:24px; }
  .meeting-card{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .meeting-cta{
    align-self:flex-end;
  }
}
</style>
